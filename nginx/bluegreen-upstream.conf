# Blue-Green Nginx Upstream Configuration
# This file is dynamically modified by blue-green-switch.sh

# Blue instance
upstream sweet_narcisse_blue {
    server app-blue:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Green instance
upstream sweet_narcisse_green {
    server app-green:3002 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Active upstream (switched by deployment script)
# Default: blue
upstream sweet_narcisse_active {
    server app-blue:3001;
    keepalive 32;
}

# Health check endpoints
server {
    listen 8080;
    server_name _;
    
    location /health/blue {
        proxy_pass http://sweet_narcisse_blue/api/health;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }
    
    location /health/green {
        proxy_pass http://sweet_narcisse_green/api/health;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }
    
    location /health/active {
        proxy_pass http://sweet_narcisse_active/api/health;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }
    
    location /deployment/status {
        default_type application/json;
        return 200 '{"active": "blue", "blue": "running", "green": "stopped"}';
    }
}
