groups:
  - name: infrastructure
    rules:
      - alert: HighDiskUsage
        expr: (1 - node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 > 85
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Espace disque critique"
          description: "Le disque est plein à {{ $value | humanize }}%. Nettoyage urgent requis."

      - alert: HighMemoryUsage
        expr: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Mémoire élevée"
          description: "Utilisation mémoire à {{ $value | humanize }}%"

      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU élevé"
          description: "CPU à {{ $value | humanize }}% sur {{ $labels.instance }}"

  - name: application
    rules:
      - alert: ApplicationDown
        expr: up{job="sweet-narcisse"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Application hors ligne"
          description: "L'application Sweet Narcisse ne répond plus depuis 2 minutes"

      - alert: HighErrorRate
        expr: (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Taux d'erreur élevé"
          description: "Taux d'erreur HTTP 5xx à {{ $value | humanize }}%"

      - alert: HighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_ms_bucket[5m])) by (le)) > 2000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Latence API élevée"
          description: "P95 latency à {{ $value | humanize }}ms (seuil: 2000ms)"

      - alert: RateLimiterBlockSpike
        expr: increase(rate_limiter_blocked_total[5m]) > 25
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pics de blocages par le rate limiter"
          description: "Plus de 25 requêtes bloquées par le rate limiter sur 5 minutes. Vérifier les flux suspects."

      - alert: DatabaseConnectionFailure
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Base de données inaccessible"
          description: "Impossible de se connecter à PostgreSQL"

  - name: business
    rules:
      - alert: NoBookingsToday
        expr: increase(sweet_narcisse_booking_count_total[6h]) == 0 AND hour() > 14
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Aucune réservation aujourd'hui"
          description: "Aucune nouvelle réservation depuis 6h (après 14h)"

      - alert: HighCancellationRate
        expr: (sum(rate(sweet_narcisse_booking_cancelled_total[1h])) / sum(rate(sweet_narcisse_booking_count_total[1h]))) * 100 > 20
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Taux d'annulation élevé"
          description: "{{ $value | humanize }}% d'annulations sur 1h (seuil: 20%)"
